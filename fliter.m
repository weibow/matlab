z = [8541156
8541117
8541166
8541135
8541126
8541136
8541139
8541082
8541108
8541120
8541077
8541066
8541103
8541149
8541176
8541164
8541139
8541134
8541144
8541106
8541078
8541092
8541085
8541065
8541074
8541106
8541140
8541122
8541111
8541126
8541134
8541105
8541121
8541086
8541094
8541072
8541041
8541088
8541119
8541095
8541083
8541118
8541142
8541104
8541079
8541119
8541080
8541077
8541077
8541098
8541108
8541113
8541136
8541148
8541116
8541105
8541091
8541110
8541091
8541102
8541121
8541118
8541113
8541162
8541141
8541125
8541109
8541092
8541097
8541076
8541047
8541090
8541079
8541099
8541101
8541095
8541124
8541095
8541124
8541108
8541104
8541108
8541121
8541147
8541127
8541140
8541128
8541143
8541125
8541125
8541087
8541107
8541101
8541124
8541142
8541129
8541136
8541140
8541120
8541093
8541112
8541118
8541130
8541137
8541152
8541150
8541094
8541115
8541169
8541130
8541121
8541155
8541141
8541121
8541111
8541123
8541129
8541100
8541152
8541134
8541079
8541082
8541102
8541116
8541123
8541133
8541156
8541177
8541142
8541075
8540979
8540891
8541001
8541057
8541073
8541053
8541062
8541070
8541057
8541136
8543059
8549689
8558840
8560367
8560096
8560136
8560141
8560157
8560103
8560137
8560147
8560090
8560118
8560141
8560102
8560106
8560104
8560076
8560082
8560112
8560118
8560122
8560125
8560102
8560064
8560055
8560106
8560137
8560105
8560086
8560071
8560092
8560089
8560065
8560056
8560162
8560799
8560629
8552061
8541202
8539111
8539177
8539256
8539234
8539309
8539316
8539283
8539341
8539341
8539412
8542637
8553587
8557719
8557568
8557470
8557372
8557486
8557533
8557559
8557628
8557620
8557620
8557706
8557740
8557721
8557746
8557762
8557756
8557755
8557764
8557797
8557813
8557797
8557832
8557885
8558456
8558969
8549837
8538552
8536895
8536988
8537051
8537090
8537124
8537097
8537161
8537248
8538944
8544816
8548089
8549232
8549213
8549973
8550312
8550423
8550745
8550784
8551046
8551193
8551274
8551608
8551479
8551166
8547244
8539165
8533483
8531410
8531297
8531364
8531390
8531488
8531603
8531627
8531633
8531707
8533993
8544429
8553740
8551972
8550687
8551017
8551233
8551202
8551373
8551416
8551555
8551629
8551593
8551787
8551927
8551812
8551828
8552186
8550990
8543228
8534442
8531008
8530914
8530946
8530966
8531044
8531101
8531139
8531185
8531161
8531120
8531168
8531217
8531250
8531230
8531230
8531284
8531294
8531298
8531308
8531316
8531378
8531348
8531334
8531409
8531389
8531405
8531424
8531455
8531439
8531462
8531420
8531409
8531438
8531468
8531481
8531472
8531431
8531481
8531508
8531479
8531568
8535087
8547624
8553604
8552833
8552556
8552744
8552978
8552762
8552798
8552901
8552897
8553004
8552902
8552877
8552941
8552893
8552879
8552917
8552858
8552885
8552953
8552954
8552965
8552996
8552991
8552947
8552943
8552984
8552951
8552962
8552997
8553012
8553017
8553006
8552998
8553020
8553031
8553020
8553024
8553057
8553055
8553034
8553003
8552988
8553024
8552989
8553037
8553022
8553027
8553037
8553018
8553286
8553686
8553966
8555029
8555793
8556365
8556396
8555958
8551821
8542556
8534857
8532422
8532327
8532399
8532465
8532475
8532505
8532565
8532595
8532625
8532629
8532616
8533090
8539899
8549339
8549931
8549945
8550327
8550385
8550504
8550507
8550614
8550750
8550748
8550790
8550847
8550855
8550898
8550888
8550884
8550924
8550935
8550943
8550968
8550947
8550958
8550997
8551007
8550980
8550986
8550982
8550970
8550968
8550942
8550943
8550939
8550919
8550922
8550979
8550972
8550981
8550979
8550994
8550987
8550982
8551027
8551077
8551051
8551032
8551021
8551007
8551005
8551019
8551021
8551017
8551033
8550990
8551006
8551013
8551017
8551020
8551046
8551046
8551060
8551080
8551040
8551030
8551021
8551042
8551036
8551030
8551046
8551045
8551053
8551040
8551041
8551012
8551087
8551084
8551059
8551062
8551061
8551091
8551072
8551025
8551131
8551771
8550845
8541290
8532376
8530229
8530109
8530232
8530346
8530395
8530404
8530465
8530479
8530508
8530534
8530523
8530614
8532674
8540558
8549275
8551575
8551298
8551333
8551291
8551252
8551251
8551258
8551212
8551198
8551214
8551195
8551209
8551247
8551266
8551243
8551243
8551222
8551245
8551255
8551181
8551199
8551193
8551194
8551215
8551170
8551159
8551177
8551159
8551203
8551212
8551198
8551224
8551182
8551202
8551211
8551201
8551178
8551192
];


A_LOWPASS_NUMERATOR		= 180;			
A_LOWPASS_DENOMINATOR	= 256;

% 初始化参数
%n_iter = 400;       %计算连续n_iter个时刻
n_iter = size(z);
sz = [n_iter, 1]; 
x = 24;             % 温度的真实值
% Q = 4e-4;           % 对温度预测值的方差
Q = 1.2;           % 对温度预测值的方差
R = 8.1;           % 测量方差，反应温度计的测量精度

delta_start = 1;    %温度初始估计方差
%z = x + sqrt(R)*randn(sz); 

raw = zeros(sz);
for k = 1 : n_iter
    raw(k) = z(k);
end

last_sample = 0;
for k = 1 : n_iter 
    z(k) = last_sample + (z(k) - last_sample)* A_LOWPASS_NUMERATOR / A_LOWPASS_DENOMINATOR;
    last_sample = z(k);
end
% z是温度计的测量结果，在真实值的基础上加上了方差为0.25的高斯噪声。
% 初始化数组
state_kalman=zeros(sz); 
% 对温度的估计值。即在k时刻，结合温度计当前测量值与k-1时刻预测值，得到的最终估计值
variance_kalman=zeros(sz);         % 估计值的方差
state_pre=zeros(sz); % 对温度的预测
variance_pre=zeros(sz);    % 预测值的方差9
K=zeros(sz);         % 卡尔曼增益
T_start = z(1);     %温度初始估计值
state_kalman(1) = T_start;   %温度估计值初始化
variance_kalman(1) =delta_start;   %估计值方差初始化

%开始迭代计算
for k = 2:n_iter
state_pre(k) = state_kalman(k-1);
%用上一时刻的最优估计值来作为对当前时刻的温度的预测
variance_pre(k) = variance_kalman(k-1)+Q;
%预测的方差为上一时刻温度最优估计值的方差与高斯噪声方差之和
%
%计算卡尔曼增益
K(k) = variance_pre(k)/( variance_pre(k)+R ); 
%
%结合当前时刻温度计的测量值，对上一时刻的预测进行校正，得到校正后的最优估计。由于是直接测量，故C为1.
state_kalman(k) = state_pre(k)+K(k)*(z(k)-state_pre(k)); 
variance_kalman(k) = (1-K(k))*variance_pre(k); 
%计算最终估计值的方差用于下一次迭代
end
%绘图相关。。。。。
FontSize=14;
LineWidth=3;
figure();
startPoint = 20;
endPoint = size(raw);
plot(z(startPoint:endPoint),'k+'); %画出温度计的测量值
plot(z(startPoint:endPoint),'k-','LineWidth',LineWidth) %画出最优估计值
hold on;
plot(state_kalman(startPoint:endPoint),'b-','LineWidth',LineWidth) %画出最优估计值
hold on;

plot(raw(startPoint:endPoint), 'g-', 'LineWidth', LineWidth);
%axis([1 500 800000 900000]); 
%plot(x*ones(sz),'g-','LineWidth',LineWidth); %画出真实值
legend('温度测量值', 'Kalman估计值');
xl=xlabel('时间(分钟)');
yl=ylabel('温度');
set(xl,'fontsize',FontSize);
set(yl,'fontsize',FontSize);
hold off;
set(gca,'FontSize',FontSize);
%figure();
valid_iter = [2:n_iter]; % variance_pre not valid at step 1
% plot(valid_iter,variance_kalman([valid_iter]),'LineWidth',LineWidth); %画出最优估计值的方差
% legend('Kalman估计的误差估计');
xl=xlabel('时间(分钟)');
yl=ylabel('℃^2');
set(xl,'fontsize',FontSize);
set(yl,'fontsize',FontSize);
set(gca,'FontSize',FontSize);